FROM nginx:alpine

# Copy Hardened Config
COPY nginx.conf /etc/nginx/nginx.conf
COPY index.html /usr/share/nginx/html/index.html

# Permission Fixes for Non-Root
# Nginx needs to write to /var/cache/nginx and /tmp
RUN chown -R nginx:nginx /usr/share/nginx/html && \
    chmod -R 755 /usr/share/nginx/html && \
    chown -R nginx:nginx /var/cache/nginx && \
    chown -R nginx:nginx /var/log/nginx && \
    chown -R nginx:nginx /etc/nginx/conf.d
    
# PID file location update handled in nginx.conf (pid /tmp/nginx.pid)

# Switch to Non-Root User
USER nginx

# Healthcheck (Port 8080)
HEALTHCHECK --interval=30s --timeout=3s \
  CMD wget -qO- http://127.0.0.1:8080/ || exit 1

EXPOSE 8080
